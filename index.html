<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; worker-src 'self' blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'none'">
    <title>Roman's Rater 4.21 - AL Insurance Rating Tool</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Watermark -->
        <div class="watermark" aria-hidden="true">
            <img src="assets/whale-glasses.svg" alt="">
        </div>

        <!-- Header -->
        <header class="app-header">
            <h1>Roman's Rater 4.21</h1>
            <p class="subtitle">Commercial Auto Liability Insurance Rating Tool</p>
            <button id="about-btn" class="btn-secondary" aria-label="About this application">About</button>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <!-- Tab Navigation -->
            <nav class="tabs" role="tablist" aria-label="Application sections">
                <button class="tab active" role="tab" aria-selected="true" aria-controls="upload-panel" id="upload-tab">Upload</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="parsed-panel" id="parsed-tab">Parsed Data</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="rating-panel" id="rating-tab">AL Base Rating</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="fees-panel" id="fees-tab">Fees & Taxes</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="results-panel" id="results-tab">Results</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="export-panel" id="export-tab">Audit Export</button>
            </nav>

            <!-- Tab Panels -->
            <div class="tab-content">
                <!-- Upload Panel -->
                <section id="upload-panel" class="panel active" role="tabpanel" aria-labelledby="upload-tab">
                    <h2>Upload Files</h2>
                    <div class="upload-section">
                        <div class="upload-group">
                            <label for="pdf-upload">CWIS Quote PDF(s):</label>
                            <input type="file" id="pdf-upload" accept=".pdf" multiple aria-describedby="pdf-help">
                            <p id="pdf-help" class="help-text">Upload one or more CWIS Quote PDFs (max 50MB each)</p>
                            <div id="pdf-list" class="file-list" role="list" aria-live="polite"></div>
                        </div>

                        <div class="upload-group">
                            <label for="rater-upload">Cover Whale Rater (Excel):</label>
                            <input type="file" id="rater-upload" accept=".xlsx,.xls" aria-describedby="rater-help">
                            <p id="rater-help" class="help-text">Upload 2025 Cover Whale Rater Version 4.21.xlsx (max 20MB)</p>
                            <div id="rater-file" class="file-list" role="status" aria-live="polite"></div>
                        </div>

                        <div class="upload-group">
                            <label for="taxes-upload">State Taxes & Fees (Excel):</label>
                            <input type="file" id="taxes-upload" accept=".xlsx,.xls" aria-describedby="taxes-help">
                            <p id="taxes-help" class="help-text">Upload State Taxes and Fees 2025.xlsx (max 20MB)</p>
                            <div id="taxes-file" class="file-list" role="status" aria-live="polite"></div>
                        </div>

                        <div class="button-group">
                            <button id="use-preloaded-btn" class="btn-secondary">Use Pre-loaded Tables</button>
                            <button id="parse-pdf-btn" class="btn-primary" disabled>Parse PDFs</button>
                            <button id="load-tables-btn" class="btn-primary" disabled>Load Rating Tables</button>
                        </div>

                        <div id="upload-status" class="status-message" role="status" aria-live="polite"></div>
                    </div>
                </section>

                <!-- Parsed Data Panel -->
                <section id="parsed-panel" class="panel" role="tabpanel" aria-labelledby="parsed-tab" hidden>
                    <h2>Parsed Data</h2>
                    <div id="parsed-content" class="data-display" role="region" aria-live="polite">
                        <p class="placeholder">Upload and parse PDFs to view extracted data</p>
                    </div>
                </section>

                <!-- AL Base Rating Panel -->
                <section id="rating-panel" class="panel" role="tabpanel" aria-labelledby="rating-tab" hidden>
                    <h2>AL Base Rating Configuration</h2>
                    <div class="rating-config">
                        <div class="form-group">
                            <label for="limit-select">Liability Limit:</label>
                            <select id="limit-select" aria-describedby="limit-help">
                                <option value="">-- Select Limit --</option>
                                <option value="CSL_1M">CSL $1,000,000</option>
                                <option value="CSL_2M">CSL $2,000,000</option>
                                <option value="1M_2M">$1M/$2M Split</option>
                            </select>
                            <p id="limit-help" class="help-text">Liability coverage limit (pre-selected from PDF)</p>
                        </div>

                        <div class="form-group">
                            <label for="radius-select">Radius Bucket:</label>
                            <select id="radius-select" aria-describedby="radius-help">
                                <option value="">-- Select Radius --</option>
                                <option value="0-50">0-50 miles</option>
                                <option value="51-200">51-200 miles</option>
                                <option value="201-500">201-500 miles</option>
                                <option value="500+">500+ miles</option>
                            </select>
                            <p id="radius-help" class="help-text">Operating radius (pre-selected from PDF)</p>
                        </div>

                        <div class="form-group">
                            <label for="aggregation-select">Driver Aggregation Method:</label>
                            <select id="aggregation-select" aria-describedby="aggregation-help">
                                <option value="mean">Mean (Average)</option>
                                <option value="worst">Worst Driver</option>
                                <option value="weighted">Weighted (Primary 60%, Others 40%)</option>
                            </select>
                            <p id="aggregation-help" class="help-text">How to combine multiple driver factors</p>
                        </div>

                        <button id="recalculate-btn" class="btn-primary" disabled>Recalculate Premium</button>
                        <div id="rating-status" class="status-message" role="status" aria-live="polite"></div>
                    </div>
                </section>

                <!-- Fees & Taxes Panel -->
                <section id="fees-panel" class="panel" role="tabpanel" aria-labelledby="fees-tab" hidden>
                    <h2>Fees & Taxes Configuration</h2>
                    <div class="fees-config">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="admitted-toggle" checked>
                                Admitted Status (auto-detect)
                            </label>
                            <p class="help-text">Non-admitted policies apply SLT and stamp fees</p>
                        </div>

                        <div class="form-group">
                            <label for="broker-fee-input">Broker Fee Override ($):</label>
                            <input type="number" id="broker-fee-input" min="0" step="0.01" placeholder="Auto (from PDF or $0)">
                        </div>

                        <div id="fees-display" class="data-display" role="region" aria-live="polite">
                            <p class="placeholder">Calculate premium to view fees and taxes</p>
                        </div>
                    </div>
                </section>

                <!-- Results Panel -->
                <section id="results-panel" class="panel" role="tabpanel" aria-labelledby="results-tab" hidden>
                    <h2>Calculation Results</h2>
                    <div id="results-content" class="data-display" role="region" aria-live="polite">
                        <p class="placeholder">Complete calculation to view results</p>
                    </div>

                    <!-- Reconciliation Section -->
                    <div id="reconciliation-section" class="reconciliation" hidden>
                        <h3>Reconciliation</h3>
                        <div id="reconciliation-content" role="region" aria-live="polite"></div>
                    </div>
                </section>

                <!-- Export Panel -->
                <section id="export-panel" class="panel" role="tabpanel" aria-labelledby="export-tab" hidden>
                    <h2>Export Audit Report</h2>
                    <div class="export-options">
                        <p>Generate audit report in your preferred format:</p>
                        <div class="button-group">
                            <button id="export-json-btn" class="btn-primary" disabled>Export JSON</button>
                            <button id="export-csv-btn" class="btn-primary" disabled>Export CSV</button>
                            <button id="export-pdf-btn" class="btn-primary" disabled>Export PDF</button>
                        </div>
                        <div id="export-status" class="status-message" role="status" aria-live="polite"></div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Settings Modal -->
        <dialog id="settings-modal" aria-labelledby="settings-title">
            <div class="modal-content">
                <h2 id="settings-title">Settings</h2>
                <form id="settings-form">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="high-contrast-toggle">
                            High Contrast Mode
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enable-ocr-toggle" checked>
                            Enable OCR for image-based PDFs
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="persist-settings-toggle">
                            Remember settings (uses localStorage)
                        </label>
                    </div>
                    <div class="button-group">
                        <button type="button" id="settings-save-btn" class="btn-primary">Save</button>
                        <button type="button" id="settings-cancel-btn" class="btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </dialog>

        <!-- About Modal -->
        <dialog id="about-modal" aria-labelledby="about-title">
            <div class="modal-content">
                <h2 id="about-title">About Roman's Rater 4.21</h2>
                <p><strong>Version:</strong> 4.21.0</p>
                <p><strong>Type:</strong> Browser-only, offline-first static web application</p>
                <h3>Privacy Notice</h3>
                <p>All data processing happens entirely in your browser. No files are uploaded to external servers. No data leaves your device.</p>
                <h3>Open Source Libraries</h3>
                <ul>
                    <li>PDF.js - PDF parsing</li>
                    <li>Tesseract.js - OCR text recognition</li>
                    <li>SheetJS - Excel workbook parsing</li>
                    <li>dayjs - Date manipulation</li>
                    <li>PapaParse - CSV generation</li>
                    <li>jsPDF - PDF generation</li>
                </ul>
                <button id="about-close-btn" class="btn-primary">Close</button>
            </div>
        </dialog>

        <!-- OCR Prompt Modal -->
        <dialog id="ocr-modal" aria-labelledby="ocr-title">
            <div class="modal-content">
                <h2 id="ocr-title">OCR Required</h2>
                <p id="ocr-message">Some PDF pages contain image-based text that requires optical character recognition (OCR).</p>
                <p>Enable text recognition for these pages?</p>
                <div id="ocr-pages-list"></div>
                <div class="button-group">
                    <button id="ocr-enable-btn" class="btn-primary">Enable OCR</button>
                    <button id="ocr-skip-btn" class="btn-secondary">Skip</button>
                </div>
            </div>
        </dialog>
    </div>

    <!-- Vendor Libraries -->
    <script src="vendor/pdf.js/pdf.min.js"></script>
    <script src="vendor/tesseract.js/tesseract.min.js"></script>
    <script src="vendor/xlsx/xlsx.full.min.js"></script>
    <script src="vendor/dayjs/dayjs.min.js"></script>
    <script src="vendor/papaparse/papaparse.min.js"></script>
    <script src="vendor/jspdf/jspdf.umd.min.js"></script>
    <script src="vendor/jspdf-autotable/jspdf.plugin.autotable.js"></script>

    <!-- Application Code -->
    <script src="src/pdf-parse.js"></script>
    <script src="src/ocr.js"></script>
    <script src="src/xlsx-ingest.js"></script>
    <script src="src/program-map.js"></script>
    <script src="src/al-engine.js"></script>
    <script src="src/fees-engine.js"></script>
    <script src="src/reconcile.js"></script>
    <script src="src/export.js"></script>
    <script src="src/ui.js"></script>
    <script type="module" src="src/main.js"></script>
</body>
</html>
